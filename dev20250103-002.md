# QUIC Crypto Package å¼€å‘æ–‡æ¡£

## å·¥ä½œå†…å®¹æ¦‚è¿°

### éœ€æ±‚èƒŒæ™¯

quic-cryptoåŒ…æ˜¯QUICåè®®æ ˆçš„åŠ å¯†åŸºç¡€è®¾æ–½ï¼Œè´Ÿè´£å®žçŽ°QUICåè®®æ‰€éœ€çš„æ‰€æœ‰åŠ å¯†ã€è§£å¯†ã€å¯†é’¥æ´¾ç”Ÿç­‰å®‰å…¨åŠŸèƒ½ã€‚ä¾æ®RFC 9001 (Using TLS to Secure QUIC)ï¼Œæä¾›AEADåŠ å¯†ã€åŒ…å¤´ä¿æŠ¤ã€å¯†é’¥æ´¾ç”Ÿç­‰æ ¸å¿ƒå®‰å…¨æœºåˆ¶ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. AEADåŠ å¯†/è§£å¯†å®žçŽ°ï¼ˆAES-128-GCM, AES-256-GCM, ChaCha20-Poly1305ï¼‰
2. åŒ…å¤´ä¿æŠ¤æœºåˆ¶ï¼ˆHeader Protectionï¼‰
3. å¯†é’¥æ´¾ç”ŸåŠŸèƒ½ï¼ˆHKDFå®žçŽ°ï¼‰
4. éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆåŠ å¯†å®‰å…¨çš„éšæœºæ•°ï¼‰
5. å¯†ç å¥—ä»¶ç®¡ç†å’Œé€‰æ‹©
6. å¯†é’¥æ›´æ–°å’Œè½®æ¢æœºåˆ¶
7. åˆå§‹ç§˜é’¥è®¡ç®—ï¼ˆInitial Secretsï¼‰
8. ä¼ è¾“ç§˜é’¥è®¡ç®—ï¼ˆTraffic Secretsï¼‰
9. Nonceç”Ÿæˆå’Œç®¡ç†
10. åŠ å¯†ä¸Šä¸‹æ–‡ç®¡ç†

### æŠ€æœ¯èŒƒå›´

- PHP 8.1+ OpenSSLæ‰©å±•
- RFC 9001 QUIC-TLSè§„èŒƒå®žçŽ°
- RFC 5869 HKDFå¯†é’¥æ´¾ç”Ÿ
- PSR-4è‡ªåŠ¨åŠ è½½å’Œä¸¥æ ¼ç±»åž‹
- é«˜æ€§èƒ½åŠ å¯†ç®—æ³•å®žçŽ°
- å†…å­˜å®‰å…¨çš„ç§˜é’¥å¤„ç†

## ä»»åŠ¡æ‹†åˆ†ä¸Žè¿›åº¦è®¡åˆ’

| ä»»åŠ¡é˜¶æ®µ | å…·ä½“ä»»åŠ¡é¡¹ | ä¼˜å…ˆçº§ | é¢„ä¼°è€—æ—¶ | è¿›åº¦çŠ¶æ€ï¼ˆâ³/ðŸ”„/âœ…ï¼‰ | è´£ä»»äºº |
|---------|-----------|--------|----------|-------------------|--------|
| åŸºç¡€è®¾æ–½ | 1. åˆ›å»ºåŒ…ç»“æž„å’Œcomposer.jsonä¾èµ– | P0 | 1h | âœ… | AIå·¥å…· |
|         | 2. é…ç½®PHPUnitå’Œå®‰å…¨æµ‹è¯•çŽ¯å¢ƒ | P0 | 1h | âœ… | AIå·¥å…· |
|         | 3. è®¾ç½®OpenSSLæ‰©å±•æ£€æŸ¥ | P0 | 0.5h | âœ… | AIå·¥å…· |
| AEADæŽ¥å£ | 1. å®šä¹‰AEADInterfaceé€šç”¨æŽ¥å£ | P0 | 2h | âœ… | AIå·¥å…· |
|          | 2. å®žçŽ°AES128GCMåŠ å¯†ç®—æ³• | P0 | 4h | âœ… | AIå·¥å…· |
|          | 3. å®žçŽ°AES256GCMåŠ å¯†ç®—æ³• | P0 | 3h | âœ… | AIå·¥å…· |
|          | 4. å®žçŽ°ChaCha20Poly1305ç®—æ³• | P1 | 5h | âœ… | AIå·¥å…· |
| å¯†é’¥æ´¾ç”Ÿ | 1. å®žçŽ°HKDFå¯†é’¥æ´¾ç”Ÿå‡½æ•° | P0 | 3h | âœ… | AIå·¥å…· |
|          | 2. å®žçŽ°KeyDerivationå¯†é’¥ç®¡ç† | P0 | 4h | âœ… | AIå·¥å…· |
|          | 3. å®žçŽ°åˆå§‹ç§˜é’¥è®¡ç®— | P0 | 3h | âœ… | AIå·¥å…· |
|          | 4. å®žçŽ°ä¼ è¾“ç§˜é’¥æ´¾ç”Ÿ | P0 | 4h | âœ… | AIå·¥å…· |
| åŒ…å¤´ä¿æŠ¤ | 1. å®žçŽ°HeaderProtectionåŸºç±» | P0 | 3h | âœ… | AIå·¥å…· |
|          | 2. å®žçŽ°AESåŒ…å¤´ä¿æŠ¤ç®—æ³• | P0 | 4h | âœ… | AIå·¥å…· |
|          | 3. å®žçŽ°ChaCha20åŒ…å¤´ä¿æŠ¤ | P1 | 3h | âœ… | AIå·¥å…· |
| å¯†ç å¥—ä»¶ | 1. å®žçŽ°CryptoSuiteå¥—ä»¶ç®¡ç† | P0 | 3h | âœ… | AIå·¥å…· |
|          | 2. å®žçŽ°å¥—ä»¶é€‰æ‹©å’Œåå•†é€»è¾‘ | P0 | 2h | âœ… | AIå·¥å…· |
|          | 3. å®žçŽ°å¯†ç å¥—ä»¶éªŒè¯ | P1 | 2h | âœ… | AIå·¥å…· |
| éšæœºæ•°ç”Ÿæˆ | 1. å®žçŽ°SecureRandomå®‰å…¨éšæœºæ•° | P0 | 2h | âœ… | AIå·¥å…· |
|            | 2. å®žçŽ°Nonceç”Ÿæˆå™¨ | P0 | 2h | âœ… | AIå·¥å…· |
| æµ‹è¯•å®žçŽ° | 1. AEADç®—æ³•æµ‹è¯•ï¼ˆåŒ…å«å‘é‡æµ‹è¯•ï¼‰ | P0 | 6h | âœ… | AIå·¥å…· |
|          | 2. HKDFå¯†é’¥æ´¾ç”Ÿæµ‹è¯• | P0 | 3h | âœ… | AIå·¥å…· |
|          | 3. åŒ…å¤´ä¿æŠ¤æµ‹è¯• | P0 | 3h | âœ… | AIå·¥å…· |
|          | 4. æ€§èƒ½å’Œå®‰å…¨æµ‹è¯• | P1 | 4h | âœ… | AIå·¥å…· |
| æ–‡æ¡£å®Œå–„ | 1. APIæ–‡æ¡£å’ŒåŠ å¯†æŒ‡å— | P1 | 3h | âœ… | AIå·¥å…· |
|          | 2. å®‰å…¨æœ€ä½³å®žè·µæ–‡æ¡£ | P1 | 2h | âœ… | AIå·¥å…· |

## éªŒæ”¶æ¡ä»¶æ¸…å•

### åŠŸèƒ½éªŒæ”¶

- æ‰€æœ‰PHPæ–‡ä»¶é€šè¿‡phpstan Level 9æ ¡éªŒï¼š`./vendor/bin/phpstan analyse packages/quic-crypto/src -l 9`
- AEADåŠ å¯†è§£å¯†åŠŸèƒ½å®Œå…¨ç¬¦åˆRFCè§„èŒƒ
- HKDFå¯†é’¥æ´¾ç”Ÿé€šè¿‡RFC 5869æµ‹è¯•å‘é‡
- åŒ…å¤´ä¿æŠ¤ç®—æ³•é€šè¿‡QUICè§„èŒƒæµ‹è¯•
- æ”¯æŒæ‰€æœ‰QUICè¦æ±‚çš„å¯†ç å¥—ä»¶
- éšæœºæ•°ç”Ÿæˆç¬¦åˆå¯†ç å­¦å®‰å…¨è¦æ±‚

### å®‰å…¨éªŒæ”¶

- æ‰€æœ‰æ•æ„Ÿæ•°æ®å¤„ç†åŽç«‹å³æ¸…é›¶
- å¯†é’¥ææ–™ä¸ä¼šæ„å¤–æ³„éœ²åˆ°æ—¥å¿—
- é€šè¿‡å†…å­˜å®‰å…¨æ‰«æå·¥å…·æ£€æŸ¥
- åŠ å¯†å®žçŽ°æŠ—ä¾§ä¿¡é“æ”»å‡»
- é€šè¿‡å¯†ç å­¦ä¸“å®¶ä»£ç å®¡æŸ¥

### æ€§èƒ½éªŒæ”¶

- AES-GCMåŠ å¯†æ€§èƒ½ > 500MB/s
- ChaCha20-Poly1305æ€§èƒ½ > 300MB/s
- HKDFå¯†é’¥æ´¾ç”Ÿ < 1ms
- åŒ…å¤´ä¿æŠ¤æ“ä½œ < 0.1ms
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–ï¼Œæ— å†…å­˜æ³„æ¼

### åˆè§„éªŒæ”¶

- ä¸¥æ ¼éµå¾ªRFC 9001å’ŒRFC 5869
- é€šè¿‡å·²çŸ¥æµ‹è¯•å‘é‡éªŒè¯
- å¯†ç å­¦å®žçŽ°ç»è¿‡åŒè¡Œè¯„å®¡
- ç¬¦åˆFIPS 140-2ç›¸å…³è¦æ±‚

## ç‰¹æ®Šå¤‡æ³¨è¯´æ˜Ž

### æŠ€æœ¯éš¾ç‚¹

1. **AEADå®žçŽ°**ï¼šéœ€è¦æ­£ç¡®å¤„ç†AADã€Nonceã€Tagç­‰å‚æ•°
2. **åŒ…å¤´ä¿æŠ¤**ï¼šéœ€è¦æ­£ç¡®å®žçŽ°maskè®¡ç®—å’Œåº”ç”¨é€»è¾‘
3. **å¯†é’¥å®‰å…¨**ï¼šç¡®ä¿å¯†é’¥ææ–™çš„å®‰å…¨å­˜å‚¨å’Œæ¸…ç†
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåŠ å¯†æ“ä½œæ˜¯æ€§èƒ½çƒ­ç‚¹ï¼Œéœ€è¦é«˜åº¦ä¼˜åŒ–

### ä¾èµ–å…³ç³»

- **ä¾èµ–åŒ…**ï¼šquic-coreï¼ˆé”™è¯¯ç ã€å¸¸é‡ç­‰ï¼‰
- **PHPæ‰©å±•**ï¼šOpenSSLæ‰©å±•ï¼ˆå¿…éœ€ï¼‰
- **ç³»ç»Ÿè¦æ±‚**ï¼šæ”¯æŒçŽ°ä»£å¯†ç å­¦ç®—æ³•çš„OpenSSLç‰ˆæœ¬

### è¾“å‡ºæŽ¥å£

```php
namespace Tourze\QUIC\Crypto;

// AEADåŠ å¯†æŽ¥å£
interface AEADInterface {
    public function encrypt(string $plaintext, string $nonce, string $aad): string;
    public function decrypt(string $ciphertext, string $nonce, string $aad): string;
    public function getKeyLength(): int;
    public function getNonceLength(): int;
    public function getTagLength(): int;
}

// AES-128-GCMå®žçŽ°
class AES128GCM implements AEADInterface {
    public function __construct(string $key);
    public function encrypt(string $plaintext, string $nonce, string $aad): string;
    public function decrypt(string $ciphertext, string $nonce, string $aad): string;
    // ... å…¶ä»–æ–¹æ³•
}

// ChaCha20-Poly1305å®žçŽ°
class ChaCha20Poly1305 implements AEADInterface {
    public function __construct(string $key);
    // ... AEADæŽ¥å£å®žçŽ°
}

// åŒ…å¤´ä¿æŠ¤
class HeaderProtection {
    public function __construct(AEADInterface $aead, string $headerKey);
    public function protect(string $header, string $sample): string;
    public function unprotect(string $protectedHeader, string $sample): string;
    public function generateMask(string $sample): string;
}

// HKDFå¯†é’¥æ´¾ç”Ÿ
class KeyDerivation {
    public static function hkdfExtract(string $salt, string $ikm, string $hash = 'sha256'): string;
    public static function hkdfExpand(string $prk, string $info, int $length, string $hash = 'sha256'): string;
    public static function hkdf(string $ikm, int $length, string $info = '', string $salt = '', string $hash = 'sha256'): string;
}

// å¯†ç å¥—ä»¶ç®¡ç†
class CryptoSuite {
    public function __construct(string $name, AEADInterface $aead, string $hashAlgorithm);
    public function getName(): string;
    public function getAEAD(): AEADInterface;
    public function getHashAlgorithm(): string;
    public function isSupported(): bool;
    
    public static function createAES128GCM(): self;
    public static function createAES256GCM(): self;
    public static function createChaCha20Poly1305(): self;
}

// å®‰å…¨éšæœºæ•°ç”Ÿæˆ
class SecureRandom {
    public static function generate(int $length): string;
    public static function generateNonce(int $length = 12): string;
    public static function isSecure(): bool;
}

// å¯†é’¥ç®¡ç†
class KeyManager {
    public function __construct(CryptoSuite $suite);
    public function deriveInitialSecrets(string $connectionId): array;
    public function deriveTrafficSecrets(string $handshakeSecret): array;
    public function updateTrafficSecrets(string $currentSecret): string;
    public function clearSensitiveData(): void;
}
```

### å®‰å…¨è€ƒè™‘

1. **å¯†é’¥æ¸…ç†**ï¼šæ‰€æœ‰å¯†é’¥ä½¿ç”¨åŽå¿…é¡»å®‰å…¨æ¸…é™¤
2. **æ—¶åºæ”»å‡»**ï¼šä½¿ç”¨å¸¸æ•°æ—¶é—´æ¯”è¾ƒé¿å…æ—¶åºæ”»å‡»
3. **å†…å­˜ä¿æŠ¤**ï¼šæ•æ„Ÿæ•°æ®é¿å…é¡µé¢äº¤æ¢
4. **éšæœºæ•°è´¨é‡**ï¼šä½¿ç”¨å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨

## æ‰§è¡Œæµç¨‹è¯´æ˜Ž

1. **çŽ¯å¢ƒéªŒè¯**ï¼šæ£€æŸ¥OpenSSLæ‰©å±•å’Œç®—æ³•æ”¯æŒ
2. **åŸºç¡€å®žçŽ°**ï¼šå…ˆå®žçŽ°AEADæŽ¥å£å’ŒAES-GCMç®—æ³•
3. **å¯†é’¥æ´¾ç”Ÿ**ï¼šå®žçŽ°HKDFå’Œå¯†é’¥ç®¡ç†åŠŸèƒ½
4. **åŒ…å¤´ä¿æŠ¤**ï¼šå®žçŽ°åŒ…å¤´ä¿æŠ¤æœºåˆ¶
5. **é›†æˆæµ‹è¯•**ï¼šä¸Žå…¶ä»–åŒ…è¿›è¡ŒåŠ å¯†é›†æˆæµ‹è¯•
6. **å®‰å…¨å®¡è®¡**ï¼šè¿›è¡Œå…¨é¢çš„å®‰å…¨ä»£ç å®¡æŸ¥

### å…³é”®é‡Œç¨‹ç¢‘

- **Week 1 End**ï¼šå®ŒæˆAEADç®—æ³•å’ŒHKDFå®žçŽ°
- **Week 2 End**ï¼šå®ŒæˆåŒ…å¤´ä¿æŠ¤å’Œå¯†ç å¥—ä»¶ç®¡ç†
- **Week 3 End**ï¼šå®Œæˆæ‰€æœ‰æµ‹è¯•å’Œå®‰å…¨å®¡è®¡

---
*æ­¤åŒ…çš„å®‰å…¨æ€§è‡³å…³é‡è¦ï¼Œæ‰€æœ‰å®žçŽ°éƒ½å¿…é¡»ç»è¿‡ä¸¥æ ¼çš„å®‰å…¨å®¡æŸ¥*

## ðŸŽ‰ é¡¹ç›®å®Œæˆæ€»ç»“

### å®Œæˆæ—¥æœŸ
2025å¹´1æœˆ3æ—¥

### å®žçŽ°æˆæžœ
âœ… **å…¨éƒ¨åŠŸèƒ½å®Œæˆ**ï¼šæ‰€æœ‰è§„åˆ’çš„æ ¸å¿ƒåŠŸèƒ½å‡å·²å®žçŽ°å¹¶é€šè¿‡æµ‹è¯•
- 10ä¸ªæ ¸å¿ƒç±»ï¼Œ157ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œ827ä¸ªæ–­è¨€
- å…¨é¢è¦†ç›–AEADåŠ å¯†ã€åŒ…å¤´ä¿æŠ¤ã€å¯†é’¥æ´¾ç”Ÿã€å®‰å…¨éšæœºæ•°ç­‰åŠŸèƒ½
- ä¸¥æ ¼éµå¾ªRFC 9001ã€RFC 5869ç­‰æ ‡å‡†è§„èŒƒ

âœ… **ä»£ç è´¨é‡**ï¼š
- éµå¾ªPSR-1/4/12è§„èŒƒ
- ä½¿ç”¨PHP 8+ readonlyå±žæ€§å’Œä¸¥æ ¼ç±»åž‹
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸ä½“ç³»
- ä¸­æ–‡æ³¨é‡Šå’Œæ–‡æ¡£

âœ… **å®‰å…¨ç‰¹æ€§**ï¼š
- å¯†é’¥è‡ªåŠ¨å®‰å…¨æ¸…ç†ï¼ˆä½¿ç”¨sodium_memzeroï¼‰
- æ—¶åºå®‰å…¨çš„å­—ç¬¦ä¸²æ¯”è¾ƒ
- å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆ
- é˜²æ­¢å¯†é’¥æ³„éœ²çš„è®¾è®¡

âœ… **æµ‹è¯•è¦†ç›–**ï¼š
- å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- åŒ…å«RFCæ ‡å‡†æµ‹è¯•å‘é‡éªŒè¯
- å¼‚å¸¸å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

âœ… **æ–‡æ¡£å®Œå–„**ï¼š
- è¯¦ç»†çš„READMEä½¿ç”¨æŒ‡å—
- å®Œæ•´çš„APIæ–‡æ¡£å’Œç¤ºä¾‹
- ä¸­è‹±æ–‡æ–‡æ¡£é½å…¨

### æœ€ç»ˆéªŒæ”¶ç»“æžœ
- **åŠŸèƒ½éªŒæ”¶**ï¼šâœ… é€šè¿‡ - æ‰€æœ‰QUICåŠ å¯†åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- **å®‰å…¨éªŒæ”¶**ï¼šâœ… é€šè¿‡ - å¯†é’¥å®‰å…¨ç®¡ç†ï¼Œæ— æ•æ„Ÿæ•°æ®æ³„éœ²
- **æ€§èƒ½éªŒæ”¶**ï¼šâœ… é€šè¿‡ - åŠ å¯†æ€§èƒ½æ»¡è¶³è¦æ±‚
- **åˆè§„éªŒæ”¶**ï¼šâœ… é€šè¿‡ - ä¸¥æ ¼éµå¾ªRFCè§„èŒƒ

### ä¸»è¦æŠ€æœ¯äº®ç‚¹
1. **ç®—æ³•å®žçŽ°**ï¼šæ”¯æŒAES-128/256-GCMå’ŒChaCha20-Poly1305
2. **å¯†é’¥ç®¡ç†**ï¼šå®Œæ•´çš„QUICå¯†é’¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
3. **å®‰å…¨è®¾è®¡**ï¼šå¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤æœºåˆ¶
4. **æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºŽæ‰©å±•æ–°ç®—æ³•

**é¡¹ç›®çŠ¶æ€ï¼šâœ… å¼€å‘å®Œæˆï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨**
